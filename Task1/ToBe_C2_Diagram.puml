@startuml Container_Diagram_Full_Infrastructure
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(passenger, "Пассажир", "Заказывает поездки")
Person(driver, "Водитель", "Принимает заказы и получает выплаты")
Person(manager, "Корпоративный менеджер", "Управляет счетами")
Person(accountant, "Бухгалтер", "Контролирует выплаты")
Person(dev_engineer, "Разработчик", "Разрабатывает новые функции")
Person(sre_engineer, "SRE инженер", "Мониторит и поддерживает систему")

System_Boundary(go_future_system, "GoFuture Platform") {
    ' ### КЛИЕНТСКИЕ ПРИЛОЖЕНИЯ ###
    Container(web_passenger, "Пассажирское приложение", "iOS/Android/Huawei", "Интерфейс для пассажиров")
    Container(web_driver, "Водительское приложение", "iOS/Android/Huawei", "Интерфейс для водителей")
    Container(web_portal, "Корпоративный веб-портал", "Web Application", "Управление заказами")
    Container(admin_portal, "Админ-панель", "Web Application", "Управление выплатами")

    Container(api_gateway, "API Gateway", "Единая точка входа запросов")
    Container(booking_service, "Booking Service", "Python/FastAPI", "Управление бронированиями")
    Container(driver_service, "Driver Service", "Python/FastAPI", "Управление водителями")
    Container(pricing_service, "Pricing Service", "Python/FastAPI", "Динамическое ценообразование")
    Container(payments_service, "Payments Service", "Python/FastAPI", "Платежи и выплаты")
    Container(notification_service, "Notification Service", "Python/FastAPI", "Уведомления")
    Container(geography_service, "Geography Service", "Python/FastAPI", "Геопоиск и маршруты")
    Container(analytics_service, "Analytics Service", "Python/FastAPI", "Сбор аналитики")
    Container(fraud_service, "Fraud Service", "Python/FastAPI", "Антифрод")

    ' ### ОСНОВНОЙ МОНОЛИТ ###
    Container(app_monolith, "GoFuture Monolith", "Django Application", "Содержит всю бизнес-логику")

    ' ### БАЗЫ ДАННЫХ ###
    ContainerDb(db_cache, "In-memory кэш", "Redis", "Кэширование данных")
    ContainerDb(db_search, "Поисковый индекс", "Elasticsearch", "Геопоиск водителей")
    ContainerDb(booking_db, "Booking DB", "PostgreSQL", "Выделена в первую очередь\n(самый критичный домен)")
    ContainerDb(driver_db, "Driver DB", "PostgreSQL", "Вторая очередь миграции")
    ContainerDb(payments_db, "Payments DB", "PostgreSQL", "Третья очередь (PCI DSS)")
    ContainerDb(shared_db, "Shared DB", "PostgreSQL", "Остальные домены временно")

    ' ### ОЧЕРЕДИ И ВОРКЕРЫ ###
    ContainerQueue(mq_broker, "Брокер сообщений", "RabbitMQ", "Очередь для фоновых задач")
    Container(app_worker, "Воркеры фоновых задач", "Celery", "Обработка асинхронных задач")

    ' ### МОНИТОРИНГ И OBSERVABILITY ###
    Container(monitoring, "Prometheus", "Monitoring System", "Сбор метрик и мониторинг")
    Container(grafana, "Grafana", "Dashboard System", "Визуализация метрик и дашборды")
    Container(loki, "Loki", "Log Aggregation", "Сбор и анализ логов")
    Container(alert_manager, "Alertmanager", "Alert System", "Управление алертами")

    ' ### CI/CD ИНФРАСТРУКТУРА ###
    Container(jenkins, "Jenkins", "CI/CD Server", "Сборка и деплой монолита")
    Container(artifact_repo, "Artifact Repository", "Docker Registry", "Хранение образов приложения")
    Container(ci_worker, "CI/CD Workers", "VM/Containers", "Выполнение задач сборки и тестов")

    ' ### АНАЛИТИЧЕСКАЯ ИНФРАСТРУКТУРА ###
    Container(analytics_engine, "Analytics Engine", "Spark/Flink", "Обработка аналитических данных")
    Container(analytics_db, "Analytics DB", "ClickHouse", "Хранение аналитических данных")
    Container(datalens, "DataLens", "BI Tool", "Визуализация бизнес-метрик")
}

' ### ВНЕШНИЕ СИСТЕМЫ ###
System_Ext(yandex_pay, "Яндекс.Пэй", "Платежный шлюз")
System_Ext(yandex_maps, "Яндекс.Карты", "Картографический сервис")
System_Ext(fcm, "FCM", "Push-сервис Google")
System_Ext(apns, "APNs", "Push-сервис Apple")
System_Ext(huawei_push, "Huawei Push Kit", "Push-сервис Huawei")
System_Ext(bank_api, "API Банка", "Банковские выплаты")

' ### СВЯЗИ ПОЛЬЗОВАТЕЛЕЙ ###
Rel(passenger, web_passenger, "Использует")
Rel(driver, web_driver, "Использует")
Rel(manager, web_portal, "Использует")
Rel(accountant, admin_portal, "Использует")
Rel(dev_engineer, jenkins, "Запускает сборки")
Rel(sre_engineer, grafana, "Мониторит систему")
Rel(sre_engineer, alert_manager, "Настраивает алерты")

' ### БИЗНЕС-ЛОГИКА ###
Rel(web_passenger, api_gateway, "HTTP/REST API")
Rel(web_driver, api_gateway, "HTTP/REST API")
Rel(web_portal, api_gateway, "HTTP/REST API")
Rel(admin_portal, api_gateway, "HTTP/REST API")

Rel(geography_service, db_cache, "Кеширование координат")
Rel(payments_service, db_cache, "Кеширование тарифов")
Rel(driver_service, db_cache, "Кеширование данных фодителей")

Rel(api_gateway, app_monolith, "Legacy endpoints\n(Strangler Fig Pattern)", "HTTP")

Rel(api_gateway, booking_service, "Создать бронирование", "HTTP/gRPC")
Rel(api_gateway, pricing_service, "Получить цену", "HTTP")
Rel(api_gateway, driver_service, "Найти водителя", "HTTP")

Rel(booking_service, mq_broker, "BookingCreated, BookingCompleted", "event")
Rel(driver_service, mq_broker, "DriverLocationUpdated", "event")
Rel(payments_service, mq_broker, "PaymentSucceeded", "event")

Rel(booking_service, pricing_service, "HTTP/REST API", "Получение стоимости улуги")

' ### ПЛАТЕЖИ ###
Rel(api_gateway, payments_service, "Обработка платежей", "HTTP/REST API")
Rel(payments_service, yandex_pay, "Обработка платежей", "HTTP/REST API")
Rel(payments_service, bank_api, "Выполняет выплаты", "HTTP/REST API")

Rel(api_gateway, geography_service, "Запросы геоданныхй", "HTTP/REST API")
Rel(geography_service, yandex_maps, "Запросы геоданных", "HTTP/REST API")
Rel(geography_service, db_search, "Геопоиск водителей", "HTTP/REST API")

Rel(app_monolith, shared_db, "Чтение/запись (ORM)", "Backward compatibility")
Rel(app_monolith, db_search, "Геопоиск водителей", "Backward compatibility")
Rel(app_monolith, mq_broker, "Отправка задач", "Backward compatibility")

Rel(app_monolith, yandex_pay, "Обработка платежей", "Backward compatibility")
Rel(app_monolith, yandex_maps, "Запросы геоданных", "Backward compatibility")
Rel(app_monolith, bank_api, "Инициирование выплат", "Backward compatibility")

Rel(mq_broker, notification_service, "Отправить пуш", "event")
Rel(mq_broker, analytics_service, "Записать в ClickHouse", "event")
Rel(booking_service, fraud_service, "Проверить на фрод", "REST API")

Rel(notification_service, fcm, "Отправляет уведомления", "REST API")
Rel(notification_service, apns, "Отправляет уведомления", "REST API")
Rel(notification_service, huawei_push, "Отправляет уведомления", "REST API")

Rel(booking_service, booking_db, "R/W", "SQL")
Rel(driver_service, driver_db, "R/W", "SQL")
Rel(payments_service, payments_db, "R/W", "SQL")
Rel(notification_service, shared_db, "R/W", "SQL")
Rel(analytics_service, shared_db, "R/W", "SQL")
Rel(fraud_service, shared_db, "R/W", "SQL")
Rel(pricing_service, shared_db, "R/W", "SQL")

' ### ASYNC WORKERS ###
Rel(app_worker, mq_broker, "Получает задачи из", "AMQP")
Rel(app_worker, shared_db, "Чтение/запись данных", "ORM")
Rel(app_worker, shared_db, "Сохраняет результаты", "ORM")

' Rel(app_worker, bank_api, "Выполняет выплаты", "REST API")

' ### МОНИТОРИНГ ###
Rel(app_monolith, monitoring, "Отправляет метрики", "Prometheus Metrics")
Rel(app_worker, monitoring, "Отправляет метрики", "Prometheus Metrics")
Rel(shared_db, monitoring, "Метрики БД", "PostgreSQL Exporter")
Rel(booking_db, monitoring, "Метрики БД", "PostgreSQL Exporter")
Rel(driver_db, monitoring, "Метрики БД", "PostgreSQL Exporter")
Rel(payments_db, monitoring, "Метрики очередей", "RabbitMQ Exporter")
Rel(mq_broker, monitoring, "Отправляет очередей", "RabbitMQ Exporter")
Rel(notification_service, monitoring, "Отправляет очередей", "RabbitMQ Exporter")
Rel(payments_service, monitoring, "Отправляет очередей", "RabbitMQ Exporter")
Rel(booking_service, monitoring, "Отправляет очередей", "RabbitMQ Exporter")
Rel(driver_service, monitoring, "Отправляет очередей", "RabbitMQ Exporter")
Rel(pricing_service, monitoring, "Отправляет очередей", "RabbitMQ Exporter")
Rel(geography_service, monitoring, "Отправляет очередей", "RabbitMQ Exporter")
Rel(analytics_service, monitoring, "Отправляет очередей", "RabbitMQ Exporter")
Rel(fraud_service, monitoring, "Отправляет очередей", "RabbitMQ Exporter")


Rel(monitoring, grafana, "Предоставляет данные", "PromQL")
Rel(monitoring, alert_manager, "Отправляет алерты", "Alert Rules")
Rel(alert_manager, sre_engineer, "Отправляет уведомления", "Email/Slack/Pager")

Rel(app_monolith, loki, "Отправляет логи", "Loki Logs")
Rel(app_worker, loki, "Отправляет логи", "Loki Logs")

' ### CI/CD ###
Rel(jenkins, ci_worker, "Запускает задачи", "SSH/API")
Rel(ci_worker, artifact_repo, "Пушит образы", "Docker Push")
Rel(jenkins, artifact_repo, "Деплоит образы", "Docker Pull")
Rel(ci_worker, app_monolith, "Запускает тесты", "Test Execution")

' ### АНАЛИТИКА ###
Rel(app_monolith, analytics_engine, "Отправляет события", "AMQP")
Rel(app_worker, analytics_engine, "Отправляет события", "AMQP")
Rel(analytics_engine, analytics_db, "Записывает данные", "ETL Process")
Rel(analytics_db,datalens, "Предоставляет данные", "SQL Queries")
Rel(datalens, manager, "Бизнес-отчеты", "Dashboards")
Rel(datalens, accountant, "Финансовые отчеты", "Dashboards")

@enduml